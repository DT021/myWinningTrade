= render partial: 'search'
hr

.row
  .span8
    h1 = @stock.name
    = render partial: 'stock/trend', locals: { stock: @stock }
  .span4
    br
    .btn-group#graph-timescale data-toggle='buttons-radio'
      button.btn.btn-primary.active data-value='live' Last day
      button.btn.btn-primary data-value='historical' Older
br

.chart_wrapper
  .row
    .span10
      #slider
    .span2

  br

  .row
    .span10
      #chart
        .spinner
          = image_tag 'graph_spinner.gif'
          h3 Loading, please wait&hellip;
    .span2
      #legend


javascript:
  function plotInputData(inputData) {
    return _.map(inputData, function(p) {
       return { x: p[0], y: p[1] };
    });
  }

  function initGraph(data) {

  var min_y = _.min(_.pluck(data,'y'));

  window.graph = new Rickshaw.Graph({
    element: document.getElementById("chart"),
    width: 770,
    height: 500,
    renderer: 'line',
    stroke: true,
    min: min_y,
    series: [
      {
        color: 'steelblue', // palette.color(),
        data: data,
        name: '#{@stock.name}'
      }
    ]
  });
  graph.inputData = data;

  $('#chart .spinner').hide();

  graph.render();
  window.graph = graph;

  var slider = new SnappySlider({ graph: graph, element: $('#slider') });

  var hoverDetail = new Rickshaw.Graph.StockHoverDetail({ graph: graph });

  //var legend = new Rickshaw.Graph.Legend({ graph: graph, element: document.getElementById('legend') });

  var ticksTreatment = 'glow';

  var xAxis = new Rickshaw.Graph.Axis.Time({ graph: graph, ticksTreatment: ticksTreatment });
  var yAxis = new Rickshaw.Graph.Axis.Y({ graph: graph, ticksTreatment: ticksTreatment });

  xAxis.render();
  yAxis.render();
  }

  $(function() {
    $.ajax({
      url: '/stock/#{@stock.symbol}/price_history.json',
      dataType: 'JSON',
      success: function(data) {
        initGraph({
          live: plotInputData(data.price_history.live),
          historical: plotInputData(data.price_history.historical)
        });
        $("#graph-timescale").show();
      }
    });

    $('#graph-timescale .btn').click(function(event) {
      $('#graph-timescale .btn').removeClass('active');
      var element = $(event.target);
      element.addClass('active');
      window.graph.series[0].data = window.graph.inputData[element.data('value')];

      if (element.data('value') == 'historical') {
        $('#slider').show();
      }
      else {
        $('#slider').hide();
      }

      graph.render();
      return false;
    });

  });
  // subscribe to:
  // -- add data to seriesData
  // -- graph.update()

br

- fields = %w(current_price stock_exchange eps_estimate_current_year earnings_share eps_estimate_next_year days_range eps_estimate_next_quarter open previous_close last_trade_time volume year_range dividend_yield)
.row
  .span6 style='background-color: #eee; height: 300px'
    ' Buy/Sell form
  .span6
    table.table.table-striped.table-compact
      tbody
      - fields.each_slice(2) do |row_fields|
        tr
          - row_fields.each do |field|
            th = field.humanize
            - value = @stock.send(field)
            td = value ? number_with_delimiter(value) : 'N/A'
          - if row_fields.count < 2
            th &nbsp;
            td &nbsp;
